#server {
#    listen 80;
#    root /usr/share/nginx/html/browser;
#    index index.html;

#    location / {
#        try_files $uri $uri/ /index.html;
#    }
#}

server {
    listen 80;
    server_name _;
    
    root /usr/share/nginx/html/browser;
    index index.html;
    
    # ===== DETECCI√ìN AUTOM√ÅTICA DE RANGO =====
    # Valor por defecto: rango 50
    set $backend_ip "172.16.50.11";
    set $backend_url "http://172.16.50.11:3000";
    set $api_url "http://172.16.50.11:3000/api";
    
    # Si el cliente viene del rango 106
    if ($remote_addr ~ "^172\.16\.106\.") {
        set $backend_ip "172.16.106.19";
        set $backend_url "http://172.16.106.19:3000";
        set $api_url "http://172.16.106.19:3000/api";
    }
    
    # Inyectar configuraci√≥n en el HTML para Angular
    sub_filter '</head>' '
        <script>
            // Configuraci√≥n inyectada por Nginx para Angular
            window.APP_CONFIG = {
                API_HOST: "$backend_ip",
                API_URL: "$api_url",
                BACKEND_URL: "$backend_url",
                CLIENT_IP: "$remote_addr",
                CLIENT_RANGE: "$backend_ip"
            };
            console.log("üåê Angular - Configuraci√≥n detectada:", window.APP_CONFIG);
        </script>
    </head>';
    sub_filter_once on;
    
    # ===== CONFIGURACI√ìN ANGULAR SPA =====
    location / {
        try_files $uri $uri/ /index.html;
        
        # Headers para SPA
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # ===== ARCHIVOS EST√ÅTICOS =====
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
